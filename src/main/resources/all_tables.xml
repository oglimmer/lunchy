<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">
    <changeSet author="oli (generated)" id="1407795125518-1">
        <createTable tableName="location">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column defaultValue="" name="officialname" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="streetname" type="VARCHAR(255)"/>
            <column defaultValue="" name="address" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="city" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="zip" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="country" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="url" type="VARCHAR(255)"/>
            <column name="comment" type="TEXT"/>
            <column name="turnAroundTime" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="0000-00-00 00:00:00" name="createdOn" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="0000-00-00 00:00:00" name="lastUpdate" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="fkUser" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="geo_lat" type="DOUBLE"/>
            <column name="geo_lng" type="DOUBLE"/>
            <column name="tags" type="TEXT"/>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1407968041666-2">
        <createTable tableName="pictures">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column name="fkLocation" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="fkUser" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="filename" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="caption" type="VARCHAR(255)"/>
            <column defaultValueComputed="CURRENT_TIMESTAMP" name="createdOn" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1407795125518-2">
        <createTable tableName="reviews">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column name="fkUser" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="fkLocation" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="TEXT"/>
            <column defaultValue="0000-00-00 00:00:00" name="createdOn" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="0000-00-00 00:00:00" name="lastUpdate" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="INT(10)"/>
            <column name="favoriteMeal" type="TEXT"/>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1407795125518-3">
        <createTable tableName="users">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column defaultValue="" name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="displayname" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="0000-00-00 00:00:00" name="createdOn" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="0000-00-00 00:00:00" name="lastLogin" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="permissions" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="passwordResetToken" type="VARCHAR(255)"/>
            <column name="passwordResetTimestamp" type="TIMESTAMP"/>
            <column name="longTimeToken" type="VARCHAR(255)"/>
            <column name="longTimeTimestamp" type="TIMESTAMP"/>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1407795125518-4">
        <addUniqueConstraint columnNames="email" constraintName="email" deferrable="false" disabled="false" initiallyDeferred="false" tableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1407795125518-5">
        <addUniqueConstraint columnNames="fkUser, fkLocation" constraintName="fkUser" deferrable="false" disabled="false" initiallyDeferred="false" tableName="reviews"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-1">
        <createTable tableName="offices">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column defaultValue="" name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="geo_lat" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="geo_lng" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="zoomfactor" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-2">
        <addColumn tableName="users">
            <column name="fkBaseOffice" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-3">
        <addColumn tableName="location">
            <column name="fkOffice" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-4">
        <addColumn tableName="reviews">
            <column name="turnAroundTime" type="INT(10)"/>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-5">
        <addForeignKeyConstraint baseColumnNames="fkOffice" baseTableName="location" constraintName="fk_loc_off" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="offices"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-6">
        <addForeignKeyConstraint baseColumnNames="fkUser" baseTableName="location" constraintName="fk_loc_usr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-7">
        <addForeignKeyConstraint baseColumnNames="fkLocation" baseTableName="pictures" constraintName="fk_pic_loc" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="location"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-8">
        <addForeignKeyConstraint baseColumnNames="fkUser" baseTableName="pictures" constraintName="fk_pic_usr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-9">
        <addForeignKeyConstraint baseColumnNames="fkLocation" baseTableName="reviews" constraintName="fk_rev_loc" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="location"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-10">
        <addForeignKeyConstraint baseColumnNames="fkUser" baseTableName="reviews" constraintName="fk_rev_usr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408201702340-11">
        <addForeignKeyConstraint baseColumnNames="fkBaseOffice" baseTableName="users" constraintName="fk_usr_off" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="offices"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-1">
        <createTable tableName="communities">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column defaultValue="" name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="domain" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="adminEmail" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-2">
        <addColumn tableName="location">
            <column name="fkCommunity" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-3">
        <addColumn tableName="offices">
            <column name="fkCommunity" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-4">
        <addColumn tableName="pictures">
            <column name="fkCommunity" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-5">
        <addColumn tableName="reviews">
            <column name="fkCommunity" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-6">
        <addColumn tableName="users">
            <column name="fkCommunity" type="INT(10)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="custom-1" author="oli (generated)">
    	<sql>insert into communities (id, name, domain, adminEmail) values (1,'ADTECH','adtech','oli@zimpasser.de')</sql>
    </changeSet>
    <changeSet id="custom-2" author="oli (generated)">
    	<sql>update location set fkCommunity=1</sql>
    </changeSet>
    <changeSet id="custom-3" author="oli (generated)">
    	<sql>update offices set fkCommunity=1</sql>
    </changeSet>
    <changeSet id="custom-4" author="oli (generated)">
    	<sql>update pictures set fkCommunity=1</sql>
    </changeSet>
    <changeSet id="custom-5" author="oli (generated)">
    	<sql>update reviews set fkCommunity=1</sql>
    </changeSet>
    <changeSet id="custom-6" author="oli (generated)">
    	<sql>update users set fkCommunity=1</sql>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-7">
        <addForeignKeyConstraint baseColumnNames="fkCommunity" baseTableName="location" constraintName="fk_loc_com" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="communities"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-8">
        <addForeignKeyConstraint baseColumnNames="fkCommunity" baseTableName="offices" constraintName="fk_off_com" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="communities"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-9">
        <addForeignKeyConstraint baseColumnNames="fkCommunity" baseTableName="pictures" constraintName="fk_pic_com" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="communities"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-10">
        <addForeignKeyConstraint baseColumnNames="fkCommunity" baseTableName="reviews" constraintName="fk_rev_com" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="communities"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408224948427-11">
        <addForeignKeyConstraint baseColumnNames="fkCommunity" baseTableName="users" constraintName="fk_usr_com" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="communities"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408230701349-1">
        <addColumn tableName="offices">
            <column defaultValue="" name="country" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-1">
        <addColumn tableName="reviews">
            <column name="onSiteTime" type="INT(10)"/>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-2">
        <addColumn tableName="reviews">
            <column name="travelTime" type="INT(10)"/>
        </addColumn>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-3">
        <addUniqueConstraint columnNames="email, fkCommunity" constraintName="email_2" deferrable="false" disabled="false" initiallyDeferred="false" tableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-4">
        <dropUniqueConstraint constraintName="email" tableName="users"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-5">
        <dropColumn columnName="turnAroundTime" tableName="reviews"/>
    </changeSet>
    <changeSet author="oli (generated)" id="1408311973443-6">
        <dropNotNullConstraint columnDataType="int(10)" columnName="turnAroundTime" tableName="location"/>
    </changeSet>
    <changeSet id="custom-7" author="oli (generated)">
    	<sql>update reviews set onSiteTime = (select turnAroundTime/2 from location where location.id=fkLocation), travelTime = (select turnAroundTime/2 from location where location.id=fkLocation)</sql>
    </changeSet>    
</databaseChangeLog>
